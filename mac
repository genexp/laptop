#!/usr/bin/env zsh

# Welcome to Matt's laptop script! Forked from thoughbot.
# Be prepared to turn your laptop (or desktop, no haters here)
# into an awesome development machine.

trap 'ret=$?; test $ret -ne 0 && printf "failed\n\n" >&2; exit $ret' EXIT

set -e

# Make sure we have Xcode command line tools
xcode-select --install

# Create ~/.bin if it doesn't exist
if [[ ! -d "$HOME/.bin/" ]]; then
  mkdir "$HOME/.bin"
fi

# Create ~/.zshrc if it doesn't exist
if [ ! -f "$HOME/.zshrc" ]; then
  touch $HOME/.zshrc
fi

# Create ~/Code if it doesn't exist
if [ ! -d "$HOME/Code/" ]; then
  mkdir "$HOME/Code"
fi

fancy_echo() {
  printf "\n%b\n" "$1"
}

# Create shell to zsh
fancy_echo "Changing your shell to zsh ..."
  chsh -s $(which zsh)

if [[ -f /etc/zshenv ]]; then
  fancy_echo "Fixing OSX zsh environment bug ..."
    sudo mv /etc/{zshenv,zshrc}
fi

echo "Checking for SSH key, generating one if it doesn't exist ..."
  [[ -f ~/.ssh/id_rsa.pub ]] || ssh-keygen -t rsa

if ! command -v brew &>/dev/null; then
  fancy_echo "Installing Homebrew, a good OS X package manager ..."
    /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
else
  fancy_echo "Homebrew already installed. Skipping ..."
fi

fancy_echo "Updating Homebrew formulas ..."
  brew update

fancy_echo "Installing homebrew packages ..."
  brew install git z zsh-syntax-highlighting awscli heroku-toolbest go python

fancy_echo "Installing docker packages ..."
  brew install docker docker-compose docker-machine docker-swarm

fancy_echo "Installing Node via n with latest and lts ..."
  brew install n
  n lts
  n latest

fancy_echo "Installing rbenv, to change Ruby versions ..."
  brew install rbenv
  eval "$(rbenv init -)"

fancy_echo "Installing ruby-build, to install Rubies ..."
  brew install ruby-build

fancy_echo "Installing Ruby 2.3.0 ..."
  rbenv install 2.3.0

fancy_echo "Setting Ruby 2.3.0 as global default Ruby ..."
  rbenv global 2.3.0
  rbenv rehash

fancy_echo "Updating to latest Rubygems version ..."
  gem update --system

fancy_echo "Installing Essential NPM Packages ..."
  npm install -g eslint gulp jshint node-inspector npm-check-updates pure-prompt xo

fancy_echo "Installing Casks"
  brew cask install caskroom/fonts/font-hack caskroom/fonts/font-source-code-pro
  brew cask install qlmarkdown qlcolorcode qlstephen quicklook-json qlimagesize
  brew cask install virtualbox vagrant

fancy_echo "Cloning VVV dev box, install vv"
  git clone git@github.com:mattbanks/VVV.git ~/vvv
  brew install bradp/vv/vv

# Get rid of zshrc and move on to the dotfiles
rm ~/.zshrc

fancy_echo "Cloning and installing dotfiles ..."
  git clone git@github.com:mattbanks/dotfiles.git ~/.dotfiles
  cd ~/.dotfiles
  script/bootstrap

fancy_echo "Installing Atom packages"
  apm stars --install

fancy_echo "Installing Xcode color scheme"
  cd ~/.dotfiles
  xcode/setup
